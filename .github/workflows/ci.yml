---
name: CI

"on":
  push:
    branches: [main]
  pull_request:

jobs:
  build-and-smoke:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v5

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Show Docker info
        run: docker info

      - name: Prepare env (defaults)
        run: |
          echo "HUB_PORT=8000" >> configs/.env || true
          echo "MEILI_PORT=${MEILI_PORT:-7701}" >> configs/.env || true
          echo "QDRANT_PORT=${QDRANT_PORT:-6336}" >> configs/.env || true
          echo "MEILI_MASTER_KEY=${MEILI_MASTER_KEY:-meili_key}" >> configs/.env || true

      - name: Launch deps (Meili + Qdrant)
        run: |
          docker compose --profile deps up -d
          sleep 5

      - name: Wait Meili
        run: |
          for i in $(seq 1 30); do
            curl -fsS http://localhost:${MEILI_PORT:-7701}/health && exit 0
            sleep 2
          done
          echo "Meili not healthy"; exit 1

      - name: (Optionnel si present) Wait Qdrant
        run: |
          if docker compose ps | grep -q qdrant; then
            for i in $(seq 1 30); do
              curl -fsS http://localhost:${QDRANT_PORT:-6336}/readyz && exit 0
              sleep 2
            done
            echo "Qdrant not healthy"; exit 1
          fi

      - name: Build app image
        run: docker compose build

      - name: Launch app profile (hub/cortex)
        run: |
          if grep -q "profiles: \[\"hub\"\]" docker-compose.yml; then
            docker compose --profile hub up -d
            curl -fsS http://localhost:${HUB_PORT:-8000}/health
          elif grep -q "profiles: \[\"cortex\"\]" docker-compose.yml; then
            docker compose --profile cortex up -d
            curl -fsS http://localhost:${CORTEX_PORT:-8100}/health
          fi

      - name: Logs (on failure)
        if: failure()
        run: docker compose logs --no-color

version: "3.9"

x-common-env: &common_env
  MEILI_HOST: ${MEILI_HOST-http://meili:7700}
  MEILI_MASTER_KEY: ${MEILI_MASTER_KEY-meili_key}
  MEILI_INDEX: ${MEILI_INDEX-docs}
  QDRANT_HOST: ${QDRANT_HOST-http://qdrant:6333}
  QDRANT_COLLECTION: ${QDRANT_COLLECTION-nexus_docs}
  CORTEX_URL: ${CORTEX_URL-http://cortex:8100}

services:
  hub:
    build: ./
    image: hub-nexus:local
    environment:
      <<: *common_env
      UVICORN_PORT: ${HUB_PORT-8000}
    ports: ["${HUB_PORT-8000}:8000"]
    command: >
      uvicorn api.main:app --host 0.0.0.0 --port 8000
    profiles: ["hub"]
    depends_on:
      - meili
      - qdrant

  meili:
    image: getmeili/meilisearch:v1.11
    environment:
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: ${MEILI_MASTER_KEY-meili_key}
    ports: ["${MEILI_PORT-7700}:7700"]
    volumes:
      - meili_data:/meili_data
    profiles: ["deps"]

  qdrant:
    image: qdrant/qdrant:v1.11.0
    ports: ["${QDRANT_PORT-6333}:6333"]
    volumes:
      - qdrant_storage:/qdrant/storage
    profiles: ["deps"]

volumes:
  meili_data: {}
  qdrant_storage: {}
